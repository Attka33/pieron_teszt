<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8">
  <title>Pieron-jelleg≈± figyelemteszt</title>
  <style>
    :root {
      /* Itt lehet egy helyen √°ll√≠tani a szimb√≥lumok m√©ret√©t (mint√°k + t√°bl√°zat) */
      --symbol-font-size: 16px;
      --cell-size: 33px;
    }

    body {
      font-family: sans-serif;
      max-width: 900px;
      margin: 20px auto;
    }

    .task-description {
  text-align: justify;
  hyphens: auto;
  }

    /* A f≈ë r√°cs (t√°bla), kezdetben rejtve */
    #grid {
      display: none;                         /* indul√°skor ne l√°tsz√≥djon */
      grid-template-columns: repeat(20, var(--cell-size));
      gap: 3px;                              /* r√°csk√∂z, hogy a keretek ne √©rjenek √∂ssze */
      margin-top: 10px;
      justify-content: center;               /* r√°cs k√∂z√©pre igaz√≠t√°sa */
    }

    /* Ha a teszt elindul, ezt az oszt√°lyt kapja, ekkor jelenik meg */
    #grid.visible {
      display: grid;
    }

    /* Teszt k√∂zben az eg√©rkattint√°sok letilt√°sa (csak billenty≈±zetes vez√©rl√©s) */
    #grid.mouse-disabled {
      pointer-events: none;
    }

    /* Szimb√≥lumok bet≈±t√≠pusa, m√©rete */
    .symbol {
      font-family: "Segoe UI Symbol", "Noto Sans Symbols", "DejaVu Sans", sans-serif;
      font-size: var(--symbol-font-size);
      line-height: 1;
    }

    /* Egy cella (n√©gyzet) a r√°csban */
    .cell {
      border: 0.5px solid #ddd;
      text-align: center;
      user-select: none;

      width: var(--cell-size);
      height: var(--cell-size);

      display: flex;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }

    /* Kijel√∂lt cella ‚Äì vastagabb fekete keret */
    .cell.selected {
      box-shadow: 0 0 0 2px #000;
    }

    /* Billenty≈±zetes ‚Äûkurzor‚Äù poz√≠ci√≥ jel√∂l√©se */
    .cell.cursor {
      box-shadow: 0 0 0 2px #007bff inset;
    }

    /* Fels≈ë s√°v: gomb, id≈ëcs√≠k, mint√°k */
    #top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    #startBtn {
      padding: 6px 12px;
      cursor: pointer;
    }

    #startBtn:disabled {
      cursor: default;
      opacity: 0.6;
    }

    /* Als√≥ s√°v ‚Äì jelenleg √ºres, de meghagyjuk, ha k√©s≈ëbb kellene ide b√°rmi */
    #bottom-bar {
      margin-top: 10px;
      text-align: center;
    }

    /* Eredm√©ny overlay (s√∂t√©t√≠tett h√°tt√©r) */
    #overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;               /* csak a v√©g√©n l√°tszik */
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.3rem;
    }

    #overlay-inner {
      background: #222;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      text-align: left;
    }

    /* Id≈ëcs√≠k tart√≥ */
    #timeBarContainer {
      width: 200px;
      height: 12px;
      background: #ddd;
      border-radius: 6px;
      overflow: hidden;
      position: relative;
      margin-left: 10px;
      display: inline-block;
    }

    /* Maga a fogy√≥ z√∂ld cs√≠k */
    #timeBar {
      position: absolute;
      right: 0;             /* ITT r√∂gz√≠tj√ºk a jobb oldalhoz */
      top: 0;
      height: 100%;
      width: 100%;  /* indul√°skor teljesen tele */
      background: linear-gradient(to right, #4caf50, #8bc34a);
      transition: width 1s linear; /* sz√©p ‚Äûfoly√≥s‚Äù fogy√°s */
    }

  
/* ---- Eredm√©ny t√°bl√°zat (egyetemi norm√°k) ---- */
.result-table{
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 1rem;
}
.result-table th, .result-table td{
  border: 1px solid #555;
  padding: 6px 8px;
}
.result-table th{
  text-align: left;
  font-weight: 600;
}
.grade-cell{
  text-align: center;
  font-weight: 700;
  border: 2px solid #fff; /* kiemel√©s */
}

</style>
</head>
<body>

  <h2 style="text-align: center;">Pieron-jelleg≈± figyelemteszt</h2>

  <p class="task-description">
    Feladat le√≠r√°sa: a <strong>"Teszt ind√≠t√°sa"</strong> ut√°n felugr√≥ mez≈ëben add meg a mint√°nak megfelel≈ëen a neved. Az "OK" gombra kattint√°s ut√°n megjelen≈ë t√°bl√°zatban
    <strong>keresd meg azokat az alakzatokat, amelyek megegyeznek a mint√°ban szerepl≈ëkkel</strong>,
    √©s az ENTER/SPACE billenty≈± lenyom√°s√°val jel√∂ld ki ≈ëket.
    <strong>FONTOS</strong>, ha kijel√∂lt√©l egy alakzatot, akkor ut√°na automatikus tov√°bbl√©ptet√©s t√∂rt√©nik,
    ellenkez≈ë esetben a &rightarrow; (jobbra ny√≠l) billenty≈±vel lehet tov√°bbl√©pni, visszal√©ptet√©si lehet≈ës√©g <strong>nincs</strong>.
    A teszt akkor fejez≈ëdik be id≈ë el≈ëtt, ha az utols√≥ alakzaton is tov√°bbl√©psz. Id≈ëkeret: <strong>5 perc</strong>.
  </p>

  <div id="top-bar">
    <button id="startBtn">Teszt ind√≠t√°sa</button>

    <div>
      <strong>H√°tral√©v≈ë id≈ë:</strong>
      <div id="timeBarContainer">
        <div id="timeBar"></div>
      </div>
    </div>

    <div>
      <strong>Mint√°k:</strong>
      <span id="targetsDisplay"></span>
    </div>
  </div>

  <!-- A szimb√≥lumr√°cs (t√°bla) -->
  <div id="grid"></div>

  <!-- Als√≥ s√°v ‚Äì jelenleg √ºres -->
  <div id="bottom-bar"></div>

  <!-- Eredm√©nyeket mutat√≥ felugr√≥ doboz -->
  <div id="overlay">
    <div id="overlay-inner">
      <h2>Eredm√©ny</h2>
      <p id="resultText"></p>
      
      <div id="sendStatus" style="margin-top:10px; font-size:0.95rem; color:#ddd;"></div>
      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
        <button type="button" onclick="copyResultsToClipboard()">Eredm√©ny m√°sol√°sa</button>
        <button type="button" onclick="resetTest()">√öjraind√≠t√°s</button>
      </div>
    </div>
  </div>

<script>
  // ----------------- PARAM√âTEREK -----------------
  const ROWS = 20;
  const COLS = 20;
  const DURATION_SECONDS = 300; // 5 perc

  // ----------------- EREDM√âNYK√úLD√âS (Google Apps Script Web App) -----------------
  // Ide m√°sold be a Deploy ut√°n kapott "Web app URL"-t (Google Apps Script)
  const RESULTS_ENDPOINT = "https://script.google.com/macros/s/AKfycbxMe-JhwR_6DStcjKwYAMtofsMyvvP0ucQwj_93KFFK9V64AqytMUJ9HWkhIs9kWq7I/exec";
  // ‚ÄûMint√°k‚Äù ‚Äì ezekre kell figyelni (ezek a c√©ljelek)
  const TARGET_SYMBOLS = ["‚ñ†", "‚ñ≤", "‚óã", "‚óá"];

  // A lehets√©ges szimb√≥lumok (k√∂zt√ºk a c√©ljelek)
  const SYMBOL_POOL = ["‚ñ†", "‚ñ≤", "‚óè", "‚óÜ", "‚ñ°", "‚ñ≥", "‚óã", "‚óá"];
  const NON_TARGET_SYMBOLS = SYMBOL_POOL.filter(s => !TARGET_SYMBOLS.includes(s));

  // Fix ar√°ny: ah√°ny c√©ljel van a SYMBOL_POOL-ban, olyan ar√°nyban legyen a t√°bl√°zatban is
  const TARGET_RATIO = TARGET_SYMBOLS.length / SYMBOL_POOL.length;

  // ----------------- √ÅLLAPOTV√ÅLTOZ√ìK -----------------
  let gridData = [];       // a r√°cs cell√°i: {symbol, isTarget, selected}
  let started = false;     // fut-e m√°r a teszt
  let timeLeft = DURATION_SECONDS;
  let timerInterval = null;
  let currentIndex = -1;   // Billenty≈±zetes "kurzor" poz√≠ci√≥ja (0..ROWS*COLS-1)
  let anonId = "";        // Kit√∂lt≈ë anonim azonos√≠t√≥ja (Startn√°l k√©rj√ºk be)

  // ----------------- DOM ELEMEK -----------------
  const gridDiv = document.getElementById("grid");
  const startBtn = document.getElementById("startBtn");
  const overlay = document.getElementById("overlay");
  const resultText = document.getElementById("resultText");
  const targetsDisplay = document.getElementById("targetsDisplay");
  const timeBar = document.getElementById("timeBar");
  const sendStatus = document.getElementById("sendStatus");

  // Indul√°skor √°ll√≠tsuk 100%-ra az id≈ëcs√≠kot
  timeBar.style.width = "100%";

  // C√©ljelek ki√≠r√°sa, azonos st√≠lussal, mint a t√°bl√°zatban
  targetsDisplay.innerHTML = TARGET_SYMBOLS
    .map(s => `<span class="symbol">${s}</span>`)
    .join('&nbsp;&nbsp;&nbsp;');

  // ----------------- SEG√âDF√úGGV√âNY: egyszer≈± kever≈ë -----------------
  function shuffle(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  // ----------------- R√ÅCS GENER√ÅL√ÅSA -----------------
  function generateGrid() {
    gridData = [];
    gridDiv.innerHTML = "";

    const totalCells = ROWS * COLS;
    const targetCount = Math.round(totalCells * TARGET_RATIO);

    // V√©letlen poz√≠ci√≥k kiv√°laszt√°sa a c√©ljelekhez
    const indices = Array.from({ length: totalCells }, (_, i) => i);
    shuffle(indices);
    const targetPositions = new Set(indices.slice(0, targetCount));

    for (let i = 0; i < totalCells; i++) {
      const isTarget = targetPositions.has(i);
      const pool = isTarget ? TARGET_SYMBOLS : NON_TARGET_SYMBOLS;
      const symbol = pool[Math.floor(Math.random() * pool.length)];

      // Bels≈ë adatstrukt√∫ra felt√∂lt√©se
      gridData.push({ symbol, isTarget, selected: false });

      // DOM elem l√©trehoz√°sa
      const cell = document.createElement("div");
      cell.className = "cell symbol";
      cell.textContent = symbol;
      cell.dataset.index = i;

      // Eg√©rkattint√°s teljes tilt√°sa (csak billenty≈±vel lehessen jel√∂lni)
      cell.addEventListener("click", (e) => {
        e.preventDefault();
        return false;
      });

      gridDiv.appendChild(cell);
    }

    // Kurzor alaphelyzetben ‚Äûnincs sehol‚Äù
    currentIndex = -1;
    updateCursor();
  }

  // ----------------- KURZOR FRISS√çT√âSE -----------------
  function updateCursor() {
    const cells = gridDiv.querySelectorAll(".cell");
    cells.forEach(c => c.classList.remove("cursor"));

    if (currentIndex >= 0 && currentIndex < cells.length) {
      cells[currentIndex].classList.add("cursor");
    }
  }

  // ----------------- AKTU√ÅLIS CELLA JEL√ñL√âSE -----------------
  function toggleCurrentCell() {
    if (!started) return;
    if (currentIndex < 0) return;

    const cellData = gridData[currentIndex];
    const cellElement = gridDiv.querySelector(`.cell[data-index="${currentIndex}"]`);
    if (!cellElement) return;

    // Ha m√°r egyszer jel√∂lve lett, ne lehessen visszavonni
    if (cellData.selected) {
      return;
    }

    // Jel√∂l√©s be√°ll√≠t√°sa
    cellData.selected = true;
    cellElement.classList.add("selected");

    // Jel√∂l√©s ut√°n automatikusan a k√∂vetkez≈ë cell√°ra l√©p
    moveToNextCell();
  }

  // ----------------- TOV√ÅBBL√âP√âS A K√ñVETKEZ≈ê CELL√ÅRA -----------------
  function moveToNextCell() {
    if (!started) return;
    const cells = gridDiv.querySelectorAll(".cell");
    if (cells.length === 0) return;

    // Ha m√©g nem √°llunk sehol, az els≈ë cell√°val kezd√ºnk
    if (currentIndex === -1) {
      currentIndex = 0;
    } else if (currentIndex < cells.length - 1) {
      // Csak jobbra lehet l√©pni, vissza nem
      currentIndex++;
    } else {
      // M√°r az utols√≥ cell√°n √°llunk, √∫jabb l√©p√©s = automatikus befejez√©s
      finishTest("auto");
      return;
    }

    updateCursor();
  }

  // ----------------- TESZT IND√çT√ÅSA -----------------
  
  // ----------------- EGYETEMI NORM√ÅK SZERINTI MIN≈êS√çT√âS -----------------
  // n (√°tn√©zett elemsz√°m) √©s T% (pontoss√°g) alapj√°n ad vissza oszt√°lyzatot
  function gradeByN(n) {
    if (n < 330) return "gyenge";
    if (n < 360) return "el√©gs√©ges";
    if (n < 380) return "k√∂zepes";
    if (n < 390) return "j√≥";
    return "kiv√°l√≥";
  }

  function gradeByT(tPercent) {
    if (tPercent < 90) return "gyenge";
    if (tPercent < 94) return "el√©gs√©ges";
    if (tPercent < 96.5) return "k√∂zepes";
    if (tPercent < 98.5) return "j√≥";
    return "kiv√°l√≥";
  }


  // ----------------- EREDM√âNYK√úLD√âS SEG√âD -----------------
  function safeSetSendStatus(htmlText) {
    if (!sendStatus) return;
    sendStatus.innerHTML = htmlText;
  }

  // Megpr√≥b√°lja elk√ºldeni az eredm√©nyeket a Google Apps Script Web App URL-re.
  // Megjegyz√©s: statikus (GitHub Pages/Netlify) k√∂rnyezetben a "no-cors" m√≥d a legstabilabb,
  // ez√©rt a v√°lasz tartalm√°t nem tudjuk kiolvasni, de a k√©r√©s jellemz≈ëen c√©lba √©r.
  async function sendResultsToSheet(payload) {
    // Ha nincs be√°ll√≠tva az endpoint, ne pr√≥b√°lkozzunk.
    if (!RESULTS_ENDPOINT || RESULTS_ENDPOINT.includes("IDE_M√ÅSOLOD")) {
      safeSetSendStatus(
        '‚ö†Ô∏è <strong>Nincs be√°ll√≠tva a Web app URL.</strong><br>' +
        'A RESULTS_ENDPOINT v√°ltoz√≥ba m√°sold be a Google Apps Script "Web app URL"-t.'
      );
      return;
    }

    safeSetSendStatus("‚è≥ Eredm√©ny elk√ºld√©se folyamatban‚Ä¶");

    try {
      await fetch(RESULTS_ENDPOINT, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });

      // "no-cors" eset√©n nem tudjuk ellen≈ërizni a v√°laszt, ez√©rt csak t√°j√©koztatunk.
      safeSetSendStatus("‚úÖ Eredm√©ny elk√ºldve.");
    } catch (err) {
      safeSetSendStatus(
        "‚ùå Nem siker√ºlt elk√ºldeni az eredm√©nyt. " +
        "K√©rlek m√°sold ki az eredm√©nyt (Eredm√©ny m√°sol√°sa), √©s k√ºldd el nekem manu√°lisan."
      );
      console.error("Eredm√©nyk√ºld√©s hiba:", err);
    }
  }

  // ----------------- V√ÅG√ìLAP M√ÅSOL√ÅS -----------------
  async function copyResultsToClipboard() {
    const text = resultText ? resultText.innerText : "";
    if (!text) return;

    try {
      await navigator.clipboard.writeText(text);
      safeSetSendStatus("üìã Eredm√©ny a v√°g√≥lapra m√°solva.");
    } catch (err) {
      window.prompt("M√°sold ki az al√°bbi sz√∂veget:", text);
      safeSetSendStatus("üìã Ha nem ment automatikusan, k√©zzel m√°solhat√≥ a felugr√≥ ablakb√≥l.");
    }
  }

function startTest() {
    if (started) return;

    // Anonim azonos√≠t√≥ bek√©r√©se (er≈ësen aj√°nlott az eredm√©nyek k√©s≈ëbbi beazonos√≠t√°s√°hoz)
    // Ha nem szeretn√©l k√©rni, hagyd √ºresen √©s a Sheetben marad √ºres.
    if (!anonId) {
      const entered = window.prompt("Add meg a vezet√©kneved + a keresztneved kezd≈ëbet≈±j√©t (pl.: Nagy F):", "");
      if (entered && entered.trim()) {
        anonId = entered.trim();
      }
    }

    started = true;

    startBtn.disabled = true;

    // A t√°bl√°zat most jelenjen meg, √©s tiltsuk az egeret
    gridDiv.classList.add("visible", "mouse-disabled");

    timeLeft = DURATION_SECONDS;

    // Indul√°skor az els≈ë cell√°n √°lljon a ‚Äûkurzor‚Äù
    currentIndex = 0;
    updateCursor();

    // Id≈ëcs√≠k visszat√∂lt√©se indul√°skor
    timeBar.style.width = "100%";

    // M√°sodpercenk√©nt cs√∂kkentj√ºk az id≈ët, √©s friss√≠tj√ºk az id≈ëcs√≠kot
    timerInterval = setInterval(() => {
      timeLeft--;

      const ratio = timeLeft / DURATION_SECONDS;
      const widthPercent = Math.max(0, ratio * 100);
      timeBar.style.width = widthPercent + "%";

      if (timeLeft <= 0) {
        clearInterval(timerInterval);
        timerInterval = null;
        finishTest("time");
      }
    }, 1000);
  }

  // ----------------- TESZT BEFEJEZ√âSE -----------------
  // reason: "time" (id≈ë lej√°rt) vagy "auto" (a t√°bl√°zat v√©g√©re √©rt)
  function finishTest(reason) {
    if (!started && reason !== "time" && reason !== "auto") return;

    started = false;

    // Id≈ëz√≠t≈ë le√°ll√≠t√°sa, ha m√©g futna
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }

    const elapsed = DURATION_SECONDS - timeLeft;
    const remaining = timeLeft < 0 ? 0 : timeLeft;

    let reasonText = "";
    if (reason === "time") {
      reasonText = "Az id≈ë lej√°rt.";
    } else if (reason === "auto") {
      reasonText = "A t√°bl√°zat v√©g√©re √©rt√©l, a teszt automatikusan lez√°rult.";
    }

    // ----------------- KI√âRT√âKEL√âS -----------------
    let hits = 0;        // helyes jel√∂l√©s (c√©l + kijel√∂lt)
    let misses = 0;      // kihagyott c√©l
    let falseAlarms = 0; // rossz jel√∂l√©s (nem c√©l, de kijel√∂lt)

    gridData.forEach(c => {
      if (c.isTarget && c.selected) hits++;
      if (c.isTarget && !c.selected) misses++;
      if (!c.isTarget && c.selected) falseAlarms++;
    });

    // Feldolgozott elemnek sz√°m√≠t minden c√©ljel + minden jel√∂lt
    const processed = gridData.filter(c => c.selected || c.isTarget).length;

    // √Åtn√©zett elemek sz√°ma (n): az utols√≥ el√©rt index + 1
    const itemsSeen = currentIndex >= 0 ? currentIndex + 1 : 0;

    // Hib√°k sz√°ma (h): kihagyott c√©ljelek + t√©ves jel√∂l√©sek
    const h = misses + falseAlarms;

    // Pieron-f√©le pontoss√°g (T%) az √°tn√©zett elemsz√°mhoz viszony√≠tva
    const tPercent = itemsSeen > 0 ? ((itemsSeen - h) * 100) / itemsSeen : 0;

    // Egyetemi norm√°k szerinti oszt√°lyzatok
    const gradeN = gradeByN(itemsSeen);
    const gradeT = gradeByT(tPercent);

    // ----------------- KIEG√âSZ√çT≈ê MUTAT√ìK (Sheet oszlopokhoz) -----------------
// Sebess√©g (elem/perc) az √°tn√©zett elemsz√°m alapj√°n
const speedEpm = elapsed > 0 ? (itemsSeen / (elapsed / 60)) : 0;

// Hibaar√°ny (√∂sszes hiba / √°tn√©zett elemsz√°m)
const errorRate = itemsSeen > 0 ? (h / itemsSeen) : 0;

// Kihagy√°si ar√°ny (kihagyott c√©l / √∂sszes c√©l)
const missRate = (hits + misses) > 0 ? (misses / (hits + misses)) : 0;

// T√©ves jel√∂l√©si ar√°ny (t√©ves jel√∂l√©s / √°tn√©zett elemsz√°m)
const faRate = itemsSeen > 0 ? (falseAlarms / itemsSeen) : 0;

// Kihagy√°s vs. t√©ves jel√∂l√©s (k√ºl√∂nbs√©g)
const missVsFa = missRate - faRate;

// F√°rad√°si mint√°zat: az √°tn√©zett elemek els≈ë 20%-a vs. utols√≥ 20%-a
function segmentStats(fromIdx, toIdxExclusive) {
  let segHits = 0, segMisses = 0, segFAs = 0;
  for (let i = fromIdx; i < toIdxExclusive; i++) {
    const c = gridData[i];
    if (!c) continue;
    if (c.isTarget && c.selected) segHits++;
    if (c.isTarget && !c.selected) segMisses++;
    if (!c.isTarget && c.selected) segFAs++;
  }
  const segN = Math.max(0, toIdxExclusive - fromIdx);
  const segErrors = segMisses + segFAs;
  const segAcc = segN > 0 ? ((segN - segErrors) / segN) : 0; // 0..1
  return { segN, segHits, segMisses, segFAs, segAcc };
}

function fatiguePatternBy20Pct(nSeen) {
  if (nSeen < 5) return "insufficient_data"; // t√∫l kev√©s elem a stabil mint√°zathoz
  const part = Math.max(1, Math.floor(nSeen * 0.2));
  const first = segmentStats(0, part);
  const last = segmentStats(nSeen - part, nSeen);

  const deltaAccPct = (last.segAcc - first.segAcc) * 100; // %-pont
  // Egyszer≈± kategoriz√°l√°s (k√ºsz√∂b: 5 %-pont)
  let label = "stabil";
  if (deltaAccPct <= -5) label = "roml√≥";
  else if (deltaAccPct >= 5) label = "javul√≥";

  // Kompakt, de inform√°ci√≥gazdag string a Sheetbe
  return `${label};acc_first=${(first.segAcc*100).toFixed(1)};acc_last=${(last.segAcc*100).toFixed(1)};dAcc=${deltaAccPct.toFixed(1)}`;
}

const fatigePat = fatiguePatternBy20Pct(itemsSeen);

// Sebess√©g‚Äìpontoss√°g profil (egyszer≈± kateg√≥ri√°k fix k√ºsz√∂b√∂kkel)
// K√ºsz√∂b√∂k: 72 elem/perc ~ 360 elem / 5 perc, pontoss√°g: 95%
function speedAccuracyProfile(spdEpm, tPct) {
  const fast = spdEpm >= 72;
  const accurate = tPct >= 95;
  if (fast && accurate) return "gyors-pontos";
  if (fast && !accurate) return "gyors-pontatlan";
  if (!fast && accurate) return "lass√∫-pontos";
  return "lass√∫-pontatlan";
}

const spdAccProfil = speedAccuracyProfile(speedEpm, tPercent);

// ----------------- EREDM√âNYEK √ñSSZE√ÅLL√çT√ÅSA √âS K√úLD√âSE -----------------
const payload = {
  timestamp: new Date().toISOString(),
  anon_id: anonId || "",
  used_sec: elapsed,
  rem_sec: remaining,

  processed: processed,
  hits: hits,
  misses: misses,
  falseAlarms: falseAlarms,

  n_scan: itemsSeen,
  t_percent: Number(tPercent.toFixed(1)),
  speed_emp: Number(speedEpm.toFixed(2)),
  error_rate: Number(errorRate.toFixed(4)),

  miss_rate: Number(missRate.toFixed(4)),
  fa_rate: Number(faRate.toFixed(4)),
  miss_vs_fa: Number(missVsFa.toFixed(4)),

  fatige_pat: fatigePat,
  spd_acc_profil: spdAccProfil
};

    // Eredm√©ny sz√∂veg √∂ssze√°ll√≠t√°sa
    resultText.innerHTML = `
      ${reasonText ? reasonText + "<br><br>" : ""}
      Felhaszn√°lt id≈ë: <strong>${elapsed}</strong> mp<br>
      H√°tral√©v≈ë id≈ë: <strong>${remaining}</strong> mp<br><br>

      Feldolgozott elemek (c√©l + jel√∂lt): <strong>${processed}</strong><br>
      Helyes tal√°latok: <strong>${hits}</strong><br>
      Kihagyott c√©ljelek: <strong>${misses}</strong><br>
      T√©ves jel√∂l√©sek: <strong>${falseAlarms}</strong><br><br>

      Sebess√©g: <strong>${speedEpm.toFixed(2)}</strong> elem/perc<br>
      Hibaar√°ny: <strong>${(errorRate*100).toFixed(1)}%</strong><br>
      Kihagy√°si ar√°ny: <strong>${(missRate*100).toFixed(1)}%</strong><br>
      T√©ves jel√∂l√©si ar√°ny: <strong>${(faRate*100).toFixed(1)}%</strong><br>
      F√°rad√°si mint√°zat: <strong>${fatigePat.split(';')[0]}</strong><br>
      Sebess√©g‚Äìpontoss√°g profil: <strong>${spdAccProfil}</strong><br>

      <table class="result-table" aria-label="Egyetemi norm√°k szerinti min≈ës√≠t√©s">
        <tr>
          <th>Mutat√≥</th>
          <th>√ârt√©k</th>
          <th>Min≈ës√≠t√©s</th>
        </tr>
        <tr>
          <td>n (√°tn√©zett elemsz√°m)</td>
          <td style="text-align:center;"><strong>${itemsSeen}</strong></td>
          <td class="grade-cell">${gradeN}</td>
        </tr>
        <tr>
          <td>T% (pontoss√°g)</td>
          <td style="text-align:center;"><strong>${tPercent.toFixed(1)}%</strong></td>
          <td class="grade-cell">${gradeT}</td>
        </tr>
      </table>
    `;

    // Overlay megjelen√≠t√©se
    overlay.style.display = "flex";

    // Eredm√©nyek elk√ºld√©se a Sheetbe (ha be van √°ll√≠tva)
    sendResultsToSheet(payload);
  }

  // ----------------- TESZT √öJRAIND√çT√ÅSA -----------------
  function resetTest() {
    // Overlay elrejt√©se, √°llapotok vissza√°ll√≠t√°sa
    overlay.style.display = "none";
    safeSetSendStatus("");
    started = false;
    currentIndex = -1;
    timeLeft = DURATION_SECONDS;

    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }

    // ‚ÄûTeszt ind√≠t√°sa‚Äù gomb √∫jra enged√©lyez√©se
    startBtn.disabled = false;

    // Id≈ëcs√≠k azonnali visszat√∂lt√©se 100%-ra
    timeBar.style.width = "100%";

    // √öj, v√©letlen t√°bl√°zat ugyanazzal az ar√°nnyal
    generateGrid();

    // √öj teszt el≈ëtt megint ne l√°tsz√≥djon, csak ind√≠t√°s ut√°n
    gridDiv.classList.remove("visible", "mouse-disabled");
  }

  // ----------------- BILLENTY≈∞ZETKEZEL√âS -----------------
  // SPACE / ENTER: jel√∂l√©s (v√©gleges), jobbra ny√≠l: l√©ptet√©s
  document.addEventListener("keydown", (e) => {
    if (!started) return;

    if (e.key === "ArrowRight") {
      e.preventDefault();
      moveToNextCell();
    } else if (e.key === " " || e.key === "Enter") {
      e.preventDefault();
      toggleCurrentCell();
    }
  });

  // ----------------- INDUL√ÅSKOR: T√ÅBLA EL≈êK√âSZ√çT√âSE -----------------
  generateGrid();
  startBtn.addEventListener("click", startTest);
</script>

</body>
</html>
